# SLEEP_SMART 睡眠监测系统固件

## 项目简介

SLEEP_SMART 是基于 STM32F103 系列单片机的睡眠监测系统固件，主要实现心率、呼吸率的实时采集、滤波、检测与串口输出，适用于智能床垫、健康监测等场景。

## 硬件平台

- 主控芯片：STM32F103 系列（Cortex-M3 内核）
- 采集模块：FS800（压力/生理信号传感器）
- 通信接口：USART1/USART2
- 采样率：40Hz

## 主要功能

- 实时采集生理信号（心率、呼吸率）
- 滑动窗口数据处理（30 秒窗口，3 秒滑动步长）
- 心率、呼吸率滤波与波峰波谷检测
- 结果通过串口输出，便于上位机或其他设备读取

## 目录结构

```
SLEEP_SMART/
├── CORE/           # ARM Cortex-M3 内核与启动文件
├── FWLIB/          # STM32F10x 标准外设库
│   ├── inc/        # 外设库头文件
│   └── src/        # 外设库源文件
├── HARDWARE/       # 硬件驱动与算法实现
│   ├── AD.c/h      # ADC 采集相关
│   ├── DMA.c/h     # DMA 采集与滑动窗口管理
│   ├── Filter.c/h  # 心率/呼吸滤波算法
│   ├── findpeak.c/h# 波峰波谷检测算法
│   ├── fs800.c/h   # 传感器驱动
│   ├── TIM3.c/h    # 定时器驱动（25ms定时）
│   └── NVIC.c/h    # 中断优先级配置
├── SYSTEM/         # 系统级支持代码
│   ├── delay/      # 延时函数
│   ├── sys/        # 系统初始化
│   └── usart/      # 串口驱动
├── USER/           # 用户主程序与配置
│   ├── main.c      # 主程序入口
│   ├── stm32f10x_it.c/h # 中断服务函数
│   ├── system_stm32f10x.c/h # 系统时钟等
│   ├── DebugConfig/ # 调试配置
│   ├── Listings/    # 编译输出
│   └── Objects/     # 编译中间文件
└── README.md        # 项目说明文档
```

## 核心流程说明

1. **系统初始化**：
   - 配置中断优先级、延时、供电管理、串口、ADC、DMA、定时器等。
2. **数据采集**：
   - 通过 ADC+DMA 以 40Hz 采样率采集传感器信号，数据存入环形缓冲区。
   - 每 30 秒形成一个分析窗口，3 秒滑动一次。
3. **信号处理**：
   - 对窗口内数据分别进行心率、呼吸率滤波（带通滤波）。
   - 采用波峰波谷检测算法，计算心率与呼吸率。
4. **结果输出**：
   - 通过串口将心率、呼吸率等数据以特定格式输出，供上位机或其他设备读取。

## 主要模块说明

- **main.c**：主流程控制，初始化各模块，循环检测滑动窗口处理标志，调用滤波与检测算法，输出结果。
- **DMA.c/h**：DMA 配置与滑动窗口数据管理，负责高效采集与数据搬运。
- **Filter.c/h**：实现心率、呼吸率的带通滤波算法。
- **findpeak.c/h**：实现波峰波谷检测与心率/呼吸率计算。
- **usart.c/h**：串口初始化与数据发送。
- **TIM3.c/h**：定时器配置，用于定时触发 ADC 采样。
- **AD.c/h**、**fs800.c/h**：传感器与 ADC 相关驱动。

## 串口输出格式

- 主要通过 USART2/USART1 输出，格式如：
  ```
  <心率>|<呼吸率>|E\r\n
  例如：75|18|E\r\n
  ```
- 可根据需要扩展为带校验、状态等信息的帧格式。

## 编译与烧录说明

1. 推荐使用 Keil MDK-ARM 5.x 及以上版本。
2. 打开 `USER/SLEEP_SMART.uvprojx` 工程文件。
3. 选择对应的目标芯片（如 STM32F103C8/RD）。
4. 编译（Build）工程，生成固件。
5. 使用 J-Link、ST-Link 等工具烧录至目标板。

## 依赖与注意事项

- 需配套 STM32F10x 标准外设库（FWLIB），已包含于本项目。
- 若编译报头文件缺失，请检查 include 路径设置。
- 传感器与硬件连接需参考原理图，确保信号采集正常。

## 联系方式

如有问题或建议，请联系项目维护者。

---

> 本项目仅供学习与研究使用，禁止用于商业用途。
